{% extends 'base.html' %}
{% block title %}Расписание {{ group.name }}{% endblock %}

{% block content %}
<h1 class="mb-4">Расписание занятий</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>{{ group.name }}</h4>

  <form method="get" class="d-flex align-items-center">
    <label class="me-2 mb-0">Неделя:</label>
    <select name="week" class="form-select form-select-sm" onchange="this.form.submit()">
      {% for w in range(1, 26) %}
        <option value="{{ w }}" {% if w == current_week %}selected{% endif %}>{{ w }}</option>
      {% endfor %}
    </select>
  </form>
</div>

<style>
  .schedule-grid { border-collapse: collapse; width: 100%; table-layout: fixed; }
  .schedule-grid th, .schedule-grid td {
    border: 1px solid #e0e0e0;
    vertical-align: top;
    padding: 4px;
  }
  .schedule-time-col {
    width: 120px;
    text-align: center;
    font-weight: 600;
    background-color: #f5f5f5;
    font-size: 12px;
  }
  .schedule-day-header {
    text-align: center;
    background-color: #2b3f8f;
    color: #fff;
    font-weight: 600;
  }
  .lesson-card {
    margin-bottom: 3px;
    padding: 4px 6px;
    color: #fff;
    border-radius: 3px;
    font-size: 12px;

    height: 70px;          /* фиксированная высота блока */
    overflow: hidden;      /* обрезаем лишний текст */
  }
  .lesson-card .lesson-kind {
  display: block;
  font-size: 11px;
  font-style: italic;
}

  .lesson-card .subject { display: block; font-weight: 600; }
  .lesson-card .teacher,
  .lesson-card .place,
  .lesson-card .group-name,
  .lesson-card .lesson-kind {
    display: block;
    font-size: 11px;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .lesson-lecture  { background-color: #f44336; }  /* красный */
  .lesson-practice { background-color: #ff9800; }  /* жёлтый/оранжевый */
  .lesson-lab      { background-color: #2196f3; }  /* синий */
</style>

{% set grid = {} %}
{% for l in lessons %}
  {% set key = (l.weekday, l.lesson_number) %}
  {% if key not in grid %}
    {% set _ = grid.update({key: [l]}) %}
  {% else %}
    {% set _ = grid[key].append(l) %}
  {% endif %}
{% endfor %}

{% set days = [
  (1, 'Пн'),
  (2, 'Вт'),
  (3, 'Ср'),
  (4, 'Чт'),
  (5, 'Пт'),
  (6, 'Сб')
] %}

{% set pair_times = [
  '8:00–9:30',
  '9:40–11:10',
  '11:20–12:50',
  '13:30–15:00',
  '15:10–16:40',
  '16:50–18:20',
  '18:30–20:00',
  '20:10–21:40'
] %}

<table class="schedule-grid">
  <thead>
    <tr>
      <th class="schedule-time-col">Пара</th>
      {% for d in days %}
        <th class="schedule-day-header">{{ d[1] }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
  {% for num in range(1,9) %}
    <tr>
      <td class="schedule-time-col">
        {{ num }}<br>
        <small>{{ pair_times[num-1] }}</small>
      </td>
      {% for d in days %}
        <td>
          {% set cell_lessons = grid.get((d[0], num), []) %}
          {% for l in cell_lessons %}
            {% if l.lesson_type == 'lecture' %}
              {% set type_class = 'lesson-lecture' %}
            {% elif l.lesson_type == 'practice' %}
              {% set type_class = 'lesson-practice' %}
            {% else %}
              {% set type_class = 'lesson-lab' %}
            {% endif %}
            <div class="lesson-card {{ type_class }}">
  <span class="subject">{{ l.subject }}</span>

  {% if l.lesson_type == 'lecture' %}
    <span class="lesson-kind">Лекция</span>
  {% elif l.lesson_type == 'practice' %}
    <span class="lesson-kind">Практика</span>
  {% elif l.lesson_type == 'lab' %}
    <span class="lesson-kind">Лабораторная работа</span>
  {% endif %}

  <span class="teacher">{{ l.teacher_name }}</span>
  <span class="place">{{ l.classroom_name }}</span>
  <span class="group-name">{{ l.group.name }}</span>
</div>

          {% endfor %}
        </td>
      {% endfor %}
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
